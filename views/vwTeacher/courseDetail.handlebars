{{!-- Teacher Course Detail --}}

<div class="container my-5">

    {{!-- Header with back --}}
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold mb-1" style="color:#160438;">
                <i class="bi bi-journal-text me-2"></i> Course Details
            </h1>
            <p class="text-muted mb-0">Overview, content & instructor information.</p>
        </div>
        <a href="/teacher/dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    {{!-- Basic Info --}}
    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-header d-flex justify-content-between align-items-center" style="background:#f7f5fb;">
            <h4 class="mb-0 fw-semibold" style="color:#160438;">
                <i class="bi bi-info-circle me-2"></i> Basic Information
            </h4>
            {{#ifEquals course.status "published"}}
            <span class="badge rounded-pill" style="background:#1f9d55;">Published</span>
            {{else}}
            <span class="badge rounded-pill bg-warning text-dark">Draft</span>
            {{/ifEquals}}
        </div>

        <div class="card-body">
            <div class="row g-4">
                {{!-- Cover --}}
                <div class="col-md-4">
                    {{#if course.image_url}}
                    <img src="{{course.image_url}}" alt="{{course.title}}" class="img-fluid rounded shadow"
                        style="object-fit:cover;">
                    {{else}}
                    <img src="/static/images/default-course.jpg" alt="No image" class="img-fluid rounded shadow"
                        style="object-fit:cover;">
                    {{/if}}
                </div>

                {{!-- Details table (gi·ªØ nguy√™n n·ªôi dung/bi·∫øn) --}}
                <div class="col-md-8">
                    <div class="table-responsive">
                        <table class="table align-middle table-borderless mb-0">
                            <tbody>
                                <tr>
                                    <th class="text-muted" style="width:210px;">Course Title:</th>
                                    <td class="fw-semibold">{{course.title}}</td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Short Description:</th>
                                    <td>{{course.short_description}}</td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Category:</th>
                                    <td>
                                        {{#if course.category_name}}
                                        <span class="badge" style="background:#e9e3ff; color:#160438;">
                                            {{course.category_name}}
                                        </span>
                                        {{else}}
                                        <span class="text-muted">Uncategorized</span>
                                        {{/if}}
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Original Price:</th>
                                    <td><strong class="text-success">{{formatNumber course.price}} VND</strong></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Promotional Price:</th>
                                    <td>
                                        {{#if course.promotional_price}}
                                        <strong class="text-danger">{{formatNumber course.promotional_price}}
                                            VND</strong>
                                        {{else}}
                                        <span class="text-muted">None</span>
                                        {{/if}}
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-muted">üë• Enrollments:</th>
                                    <td><strong>{{total_students}}</strong> students</td>
                                </tr>
                                <tr>
                                    <th class="text-muted">‚≠ê Average Rating:</th>
                                    <td>
                                        {{#if average_rating}}
                                        <span class="text-warning"><i class="bi bi-star-fill"></i> {{average_rating}} /
                                            5</span>
                                        <small class="text-muted">({{rating_count}} reviews)</small>
                                        {{else}}
                                        <span class="text-muted">No reviews yet</span>
                                        {{/if}}
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-muted">‚ù§Ô∏è Favorites:</th>
                                    <td>{{watchlist_count}} times added to wishlist</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    {{!-- Detailed Description --}}
    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-header" style="background:#f7f5fb;">
            <h4 class="mb-0 fw-semibold" style="color:#160438;">
                <i class="bi bi-align-start me-2"></i> Detailed Description
            </h4>
        </div>
        <div class="card-body">
            <div class="course-description">
                {{#if course.detailed_description}}
                {{{course.detailed_description}}}
                {{else}}
                <p class="text-muted mb-0">No detailed description available</p>
                {{/if}}
            </div>
        </div>
    </div>

    {{!-- Reviews --}}
    {{#if comments.length}}
    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-header" style="background:#f7f5fb;">
            <h4 class="mb-0 fw-semibold" style="color:#160438;">
                <i class="bi bi-chat-square-quote me-2"></i> Student Reviews
            </h4>
        </div>
        <div class="card-body">
            {{#each comments}}
            <div class="pb-3 mb-3 border-bottom">
                <div class="d-flex align-items-center mb-2">
                    <img src="{{this.profile_picture_url}}" alt="avatar" class="rounded-circle me-2" width="40"
                        height="40" style="object-fit:cover;">
                    <strong>{{this.full_name}}</strong>
                    <span class="ms-2 text-warning"><i class="bi bi-star-fill"></i> {{this.rating}}</span>
                </div>
                <p class="mb-1">{{this.comment}}</p>
                <small class="text-muted">{{this.created_at}}</small>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- Instructor --}}
    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-header" style="background:#fff3cd;">
            <h4 class="mb-0 fw-semibold text-dark">
                <i class="bi bi-person-badge me-2"></i> Instructor Information
            </h4>
        </div>
        <div class="card-body">
            <div class="row align-items-center g-3">
                <div class="col-md-2 text-center">
                    {{#if course.instructor_avatar}}
                    <img id="instructorAvatar" src="{{course.instructor_avatar}}" alt="{{course.instructor_name}}"
                        class="rounded-circle img-thumbnail" style="width:100px; height:100px; object-fit:cover;">
                    {{else}}
                    <img id="instructorAvatar" src="/static/images/default-avatar.png" alt="Avatar"
                        class="rounded-circle img-thumbnail" style="width:100px; height:100px; object-fit:cover;">
                    {{/if}}
                </div>
                <div class="col-md-10">
                    <h5 class="fw-bold mb-1">{{course.instructor_name}}</h5>
                    {{#if course.email}}
                    <p class="text-muted mb-2">
                        <i class="bi bi-envelope"></i> <strong>Email:</strong> {{course.email}}
                    </p>
                    {{/if}}
                    {{#if course.instructor_bio}}
                    <div class="mt-2">
                        <strong>Bio:</strong>
                        <p class="mt-2 mb-0">{{course.instructor_bio}}</p>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>

    {{!-- Curriculum --}}
    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-header d-flex justify-content-between align-items-center" style="background:#f7f5fb;">
            <h4 class="mb-0 fw-semibold" style="color:#160438;">
                <i class="bi bi-journal-richtext me-2"></i> Course Content
            </h4>
            <span class="badge rounded-pill bg-primary">
                {{#if chapters}}{{length chapters}}{{else}}0{{/if}} chapters
            </span>
        </div>
        <div class="card-body">
            {{#if chapters}}
            <div class="accordion" id="courseContent">
                {{#each chapters}}
                <div class="accordion-item mb-2 border-0">
                    <h2 class="accordion-header" id="heading{{id}}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse{{id}}">
                            <strong>Chapter {{chapter_order}}: {{title}}</strong>
                            <span class="badge ms-2" style="background:#e9e3ff; color:#160438;">
                                {{length (lookup ../lectures id)}} lectures
                            </span>
                        </button>
                    </h2>
                    <div id="collapse{{id}}" class="accordion-collapse collapse" data-bs-parent="#courseContent">
                        <div class="accordion-body">
                            {{#if (lookup ../lectures id)}}
                            <ol class="list-group list-group-numbered">
                                {{#each (lookup ../lectures id)}}
                                <li class="list-group-item d-flex justify-content-between align-items-start border-0 border-start border-3"
                                    style="border-color:#28a745 !important;">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-semibold">{{title}}</div>
                                        {{#if video_url}}
                                        <small class="text-muted d-inline-block me-2">
                                            <i class="bi bi-play-btn"></i> Video: {{video_url}}
                                        </small>
                                        {{/if}}
                                        {{#if duration_minutes}}
                                        <small class="text-muted">
                                            <i class="bi bi-clock"></i> {{duration_minutes}} minutes
                                        </small>
                                        {{/if}}
                                    </div>
                                </li>
                                {{/each}}
                            </ol>
                            {{else}}
                            <p class="text-muted mb-0">No lectures in this chapter yet</p>
                            {{/if}}
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>
            {{else}}
            <div class="alert alert-warning mb-0">
                <i class="bi bi-exclamation-triangle"></i> No chapters yet. Please add chapters and lectures!
            </div>
            {{/if}}
        </div>
    </div>

    {{!-- Actions --}}
    <div class="d-flex gap-2 justify-content-end">
        <a href="/teacher/course/{{course.id}}/edit" class="btn btn-brand btn-lg">
            <i class="bi bi-pencil-square"></i> Edit Course
        </a>
        <form method="POST" action="/teacher/course/{{course.id}}/delete" style="display:inline;"
            onsubmit="return confirm('‚ö†Ô∏è Are you sure you want to delete this course?\n\nAll chapters, lectures, and related data will be permanently deleted!');">
            <button type="submit" class="btn btn-danger btn-lg">
                <i class="bi bi-trash"></i> Delete Course
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const avatar = document.getElementById('instructorAvatar');
        if (!avatar) return;
        try {
            const res = await fetch('/api/user/profile');
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.profile_picture_url) {
                avatar.src = data.profile_picture_url;
            }
        } catch (err) {
            console.error('Failed to load instructor avatar:', err);
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const coverImg = document.querySelector('.img-fluid.rounded.shadow');
        if (!coverImg) return;
        try {
            const courseId = "{{course.id}}";
            const res = await fetch(`/api/courses/${courseId}`);
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.image_url) {
                coverImg.src = data.image_url.startsWith('/uploads/')
                    ? data.image_url
                    : `/uploads/${data.image_url}`;
            }
        } catch (err) {
            console.error('Failed to load course cover image:', err);
        }
    });
</script>

<style>
    .course-description {
        line-height: 1.8;
        font-size: 1rem;
    }

    .accordion-button:not(.collapsed) {
        background-color: #e9e3ff;
        color: #160438;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(22, 4, 56, .2);
    }

    thead th {
        background: #f8f9fa;
        font-weight: 600;
    }
</style>