{{!-- vwTeacher/editCourse.handlebars --}}

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary fw-bold">Chỉnh Sửa Khóa Học: {{course.title}}</h2>
    <a href="/teacher/dashboard" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Quay lại Dashboard
    </a>
  </div>

  {{!-- Thông tin cơ bản khóa học --}}
  <form action="/teacher/course/{{course.id}}/edit" method="POST" enctype="multipart/form-data" class="shadow p-4 rounded bg-light">
    <h4 class="text-info mb-3"><i class="bi bi-info-circle"></i> Thông tin cơ bản</h4>
    
    <div class="mb-3">
      <label class="fw-semibold">Tiêu đề khóa học <span class="text-danger">*</span></label>
      <input type="text" name="title" class="form-control" value="{{course.title}}" required>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">Ảnh bìa</label>
      <input type="file" name="image" class="form-control mb-2" accept="image/*">
      {{#if course.cover}}
        <img src="/static{{course.cover}}" alt="cover" width="200" class="rounded border shadow-sm">
      {{/if}}
    </div>

    <div class="mb-3">
      <label class="fw-semibold">Danh mục</label>
      <select name="category_id" class="form-control">
        <option value="">-- Chọn danh mục --</option>
        {{#each categories}}
          <option value="{{id}}" {{#ifEquals id ../course.category_id}}selected{{/ifEquals}}>{{name}}</option>
        {{/each}}
      </select>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="fw-semibold">Giá gốc (VNĐ) <span class="text-danger">*</span></label>
        <input type="number" name="price" class="form-control" value="{{course.price}}" required min="0">
      </div>
      <div class="col-md-6 mb-3">
        <label class="fw-semibold">Giá khuyến mãi (VNĐ)</label>
        <input type="number" name="promotional_price" class="form-control" value="{{course.promotional_price}}" min="0">
      </div>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">Mô tả ngắn <span class="text-danger">*</span></label>
      <textarea name="short_description" class="form-control" rows="3" required>{{course.short_description}}</textarea>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">Mô tả chi tiết</label>
      <textarea name="detailed_description" id="editor" class="form-control" rows="3">{{course.detailed_description}}</textarea>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">Trạng thái xuất bản</label>
      <select name="status" class="form-control">
        <option value="draft" {{#ifEquals course.status "draft"}}selected{{/ifEquals}}>Nháp (Chưa công khai)</option>
        <option value="published" {{#ifEquals course.status "published"}}selected{{/ifEquals}}>Đã xuất bản</option>
      </select>
    </div>

    <button type="submit" class="btn btn-success w-100 mt-3">
      <i class="bi bi-check-circle"></i> Cập nhật thông tin khóa học
    </button>
  </form>

  {{!-- Quản lý nội dung khóa học --}}
  <hr class="my-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-secondary mb-0">
      <i class="bi bi-book"></i> Nội dung khóa học (Chapters & Lectures)
    </h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addChapterModal">
      <i class="bi bi-plus-circle"></i> Thêm chương mới
    </button>
  </div>

  {{#if chapters.length}}
    {{#each chapters}}
      <div class="card mb-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
          <div>
            <strong>Chương {{chapter_order}}: {{title}}</strong>
            <span class="badge bg-light text-dark ms-2">
              {{#if (lookup ../lectures id)}}
                {{length (lookup ../lectures id)}} bài giảng
              {{else}}
                0 bài giảng
              {{/if}}
            </span>
          </div>
          <div>
            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editChapterModal{{id}}">
              <i class="bi bi-pencil"></i> Sửa
            </button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteChapterModal{{id}}">
              <i class="bi bi-trash"></i> Xóa
            </button>
          </div>
        </div>

        <div class="card-body">
          {{#if (lookup ../lectures id)}}
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th width="50">#</th>
                  <th>Tên bài giảng</th>
                  <th width="120">Thời lượng</th>
                  <th width="100">Xem trước</th>
                  <th width="150">Hành động</th>
                </tr>
              </thead>
              <tbody>
                {{#each (lookup ../lectures id)}}
                  <tr>
                    <td>{{lecture_order}}</td>
                    <td>{{title}}</td>
                    <td>{{#if duration_minutes}}{{duration_minutes}} phút{{else}}-{{/if}}</td>
                    <td>
                      {{#if is_preview_allowed}}
                        <span class="badge bg-success">Có</span>
                      {{else}}
                        <span class="badge bg-secondary">Không</span>
                      {{/if}}
                    </td>
                    <td>
                      <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editLectureModal{{id}}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteLectureModal{{id}}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>

                  {{!-- Modal Sửa Lecture --}}
                  <div class="modal fade" id="editLectureModal{{id}}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form action="/teacher/lecture/{{id}}/edit" method="POST" enctype="multipart/form-data">
                          <div class="modal-header">
                            <h5 class="modal-title">Sửa bài giảng: {{title}}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="fw-semibold">Tên bài giảng</label>
                              <input type="text" name="title" class="form-control" value="{{title}}" required>
                            </div>
                            <div class="mb-3">
                              <label class="fw-semibold">Video mới (để trống nếu không đổi)</label>
                              <input type="file" name="video" class="form-control" accept="video/*">
                              <small class="text-muted">Video hiện tại: {{video_url}}</small>
                            </div>
                            <div class="mb-3">
                              <label class="fw-semibold">Thời lượng (phút)</label>
                              <input type="number" name="duration_minutes" class="form-control" value="{{duration_minutes}}" min="0">
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="is_preview_allowed" id="preview{{id}}" {{#if is_preview_allowed}}checked{{/if}}>
                              <label class="form-check-label" for="preview{{id}}">
                                Cho phép xem trước miễn phí
                              </label>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  {{!-- Modal Xóa Lecture --}}
                  <div class="modal fade" id="deleteLectureModal{{id}}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form action="/teacher/lecture/{{id}}/delete" method="POST">
                          <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Xác nhận xóa</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <p>Bạn có chắc chắn muốn xóa bài giảng <strong>"{{title}}"</strong>?</p>
                            <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Hành động này không thể hoàn tác!</p>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-danger">Xóa</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                {{/each}}
              </tbody>
            </table>
          {{else}}
            <p class="text-muted">Chưa có bài giảng nào.</p>
          {{/if}}

          {{!-- Nút thêm Lecture --}}
          <div class="border-top pt-3 mt-3">
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addLectureModal{{id}}">
              <i class="bi bi-plus-circle"></i> Thêm bài giảng vào chương này
            </button>
          </div>

          {{!-- Modal Thêm Lecture --}}
          <div class="modal fade" id="addLectureModal{{id}}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form action="/teacher/chapter/{{id}}/lecture/add" method="POST" enctype="multipart/form-data">
                  <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Thêm bài giảng vào Chương {{chapter_order}}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="fw-semibold">Tên bài giảng <span class="text-danger">*</span></label>
                      <input type="text" name="title" class="form-control" placeholder="VD: Giới thiệu về React Hooks" required>
                    </div>
                    <div class="mb-3">
                      <label class="fw-semibold">Video <span class="text-danger">*</span></label>
                      <input type="file" name="video" class="form-control" accept="video/*" required>
                      <small class="text-muted">Định dạng: MP4, AVI, MOV, WebM</small>
                    </div>
                    <div class="mb-3">
                      <label class="fw-semibold">Thời lượng (phút)</label>
                      <input type="number" name="duration_minutes" class="form-control" placeholder="VD: 15" min="0">
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="is_preview_allowed" id="previewNew{{id}}">
                      <label class="form-check-label" for="previewNew{{id}}">
                        Cho phép xem trước miễn phí
                      </label>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">Thêm bài giảng</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          {{!-- Modal Sửa Chapter --}}
          <div class="modal fade" id="editChapterModal{{id}}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form action="/teacher/chapter/{{id}}/edit" method="POST">
                  <div class="modal-header">
                    <h5 class="modal-title">Sửa Chương {{chapter_order}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="fw-semibold">Tên chương</label>
                      <input type="text" name="title" class="form-control" value="{{title}}" required>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          {{!-- Modal Xóa Chapter --}}
          <div class="modal fade" id="deleteChapterModal{{id}}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form action="/teacher/chapter/{{id}}/delete" method="POST">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Xác nhận xóa chương</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa <strong>Chương {{chapter_order}}: {{title}}</strong>?</p>
                    <p class="text-danger">
                      <i class="bi bi-exclamation-triangle"></i> 
                      Tất cả bài giảng trong chương này cũng sẽ bị xóa!
                    </p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">Xóa chương</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

      </div>
    {{/each}}
  {{else}}
    <div class="alert alert-info text-center">
      <i class="bi bi-info-circle"></i> Chưa có chương nào được tạo. Hãy thêm chương đầu tiên!
    </div>
  {{/if}}
</div>

{{!-- Modal Thêm Chapter --}}
<div class="modal fade" id="addChapterModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/teacher/course/{{course.id}}/chapter/add" method="POST">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Thêm chương mới</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="fw-semibold">Tên chương <span class="text-danger">*</span></label>
            <input type="text" name="title" class="form-control" placeholder="VD: Giới thiệu về khóa học" required>
          </div>
          <small class="text-muted">
            <i class="bi bi-info-circle"></i> Chương sẽ được tự động đánh số thứ tự
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Thêm chương</button>
        </div>
      </form>
    </div>
  </div>
</div>


{{!-- TinyMCE Editor --}}
<script src="hw9pfh30njixlu4voz8ag8msnnnr4ofingpiklyaaie8hhdy" referrerpolicy="origin"></script>
<script>
  tinymce.init({
    selector: '#editor',
    height: 400,
    plugins: 'lists link image table code',
    toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image table | code',
    menubar: false
  });
</script>