{{!-- vwTeacher/editCourse.handlebars --}}

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary fw-bold">Ch·ªânh S·ª≠a Kh√≥a H·ªçc: {{course.title}}</h2>
    
  </div>

  {{!-- Th√¥ng tin c∆° b·∫£n kh√≥a h·ªçc --}}
  <form action="/teacher/course/{{course.id}}/edit" method="POST" enctype="multipart/form-data" class="shadow p-4 rounded bg-light">
    <h4 class="text-info mb-3"><i class="bi bi-info-circle"></i> Th√¥ng tin c∆° b·∫£n</h4>
    
    <div class="mb-3">
      <label class="fw-semibold">Ti√™u ƒë·ªÅ kh√≥a h·ªçc <span class="text-danger">*</span></label>
      <input type="text" name="title" class="form-control" value="{{course.title}}" required>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">·∫¢nh b√¨a</label>
      <input type="file" name="image" class="form-control mb-2" accept="image/*">
      {{#if course.cover}}
        <img src="/static{{course.cover}}" alt="cover" width="200" class="rounded border shadow-sm">
      {{/if}}
    </div>

    <div class="mb-3">
      <label class="fw-semibold">Danh m·ª•c</label>
      <select name="category_id" class="form-select" required>
        <option value="" disabled>-- Ch·ªçn danh m·ª•c --</option>
        {{#each categoriesTree}}
          <optgroup label="üìÅ {{this.name}}">
            {{#each this.children}}
              <option value="{{this.id}}" {{#if (eq ../selectedCategoryId this.id)}}selected{{/if}}>
                ‚Äî {{this.name}}
              </option>
            {{/each}}
          </optgroup>
        {{/each}}
      </select>
    </div>
 <div class="row">
      <div class="col-md-6 mb-3">
        <label class="fw-semibold">Gi√° g·ªëc (VNƒê) <span class="text-danger">*</span></label>
        <input type="number" name="price" class="form-control" value="{{course.price}}" required min="0">
      </div>
      <div class="col-md-6 mb-3">
        <label class="fw-semibold">Gi√° khuy·∫øn m√£i (VNƒê)</label>
        <input type="number" name="promotional_price" class="form-control" value="{{course.promotional_price}}" min="0">
      </div>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">M√¥ t·∫£ ng·∫Øn <span class="text-danger">*</span></label>
      <textarea name="short_description" class="form-control" rows="3" required>{{course.short_description}}</textarea>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">M√¥ t·∫£ chi ti·∫øt</label>
      <textarea name="detailed_description" id="editor" class="form-control" rows="3">{{course.detailed_description}}</textarea>
    </div>

    <div class="mb-3">
      <label class="fw-semibold">Tr·∫°ng th√°i xu·∫•t b·∫£n</label>
      <select name="status" class="form-control">
        <option value="draft" {{#ifEquals course.status "draft"}}selected{{/ifEquals}}>Nh√°p (Ch∆∞a c√¥ng khai)</option>
        <option value="published" {{#ifEquals course.status "published"}}selected{{/ifEquals}}>ƒê√£ xu·∫•t b·∫£n</option>
      </select>
    </div>

    <button type="submit" class="btn btn-success w-100 mt-3">
      <i class="bi bi-check-circle"></i> C·∫≠p nh·∫≠t th√¥ng tin kh√≥a h·ªçc
    </button>
  </form>

  {{!-- Qu·∫£n l√Ω n·ªôi dung kh√≥a h·ªçc --}}
  <hr class="my-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-secondary mb-0">
      <i class="bi bi-book"></i> N·ªôi dung kh√≥a h·ªçc (Chapters & Lectures)
    </h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addChapterModal">
      <i class="bi bi-plus-circle"></i> Th√™m ch∆∞∆°ng m·ªõi
    </button>
  </div>

  {{#if chapters.length}}
    {{#each chapters}}
      <div class="card mb-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
          <div>
            <strong>Ch∆∞∆°ng {{chapter_order}}: {{title}}</strong>
            <span class="badge bg-light text-dark ms-2">
              {{#if (lookup ../lectures id)}}
                {{length (lookup ../lectures id)}} b√†i gi·∫£ng
              {{else}}
                0 b√†i gi·∫£ng
              {{/if}}
            </span>
          </div>
          <div>
            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editChapterModal{{id}}">
              <i class="bi bi-pencil"></i> S·ª≠a
            </button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteChapterModal{{id}}">
              <i class="bi bi-trash"></i> X√≥a
            </button>
          </div>
        </div>

        <div class="card-body">
          {{#if (lookup ../lectures id)}}
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th width="50">#</th>
                  <th>T√™n b√†i gi·∫£ng</th>
                  <th width="120">Th·ªùi l∆∞·ª£ng</th>
                  <th width="100">Xem tr∆∞·ªõc</th>
                  <th width="150">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
                {{#each (lookup ../lectures id)}}
                  <tr>
                    <td>{{lecture_order}}</td>
                    <td>{{title}}</td>
                    <td>{{#if duration_minutes}}{{duration_minutes}} ph√∫t{{else}}-{{/if}}</td>
                    <td>
                      {{#if is_preview_allowed}}
                        <span class="badge bg-success">C√≥</span>
                      {{else}}
                        <span class="badge bg-secondary">Kh√¥ng</span>
                      {{/if}}
                    </td>
                    <td>
                      <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editLectureModal{{id}}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteLectureModal{{id}}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>

                  {{!-- Modal S·ª≠a Lecture --}}
                  <div class="modal fade" id="editLectureModal{{id}}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form action="/teacher/lecture/{{id}}/edit" method="POST" enctype="multipart/form-data">
                          <div class="modal-header">
                            <h5 class="modal-title">S·ª≠a b√†i gi·∫£ng: {{title}}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="fw-semibold">T√™n b√†i gi·∫£ng</label>
                              <input type="text" name="title" class="form-control" value="{{title}}" required>
                            </div>
                            <div class="mb-3">
                              <label class="fw-semibold">Video m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                              <input type="file" name="video" class="form-control" accept="video/*">
                              <small class="text-muted">Video hi·ªán t·∫°i: {{video_url}}</small>
                            </div>
                            <div class="mb-3">
                              <label class="fw-semibold">Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
                              <input type="number" name="duration_minutes" class="form-control" value="{{duration_minutes}}" min="0">
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="is_preview_allowed" id="preview{{id}}" {{#if is_preview_allowed}}checked{{/if}}>
                              <label class="form-check-label" for="preview{{id}}">
                                Cho ph√©p xem tr∆∞·ªõc mi·ªÖn ph√≠
                              </label>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  {{!-- Modal X√≥a Lecture --}}
                  <div class="modal fade" id="deleteLectureModal{{id}}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form action="/teacher/lecture/{{id}}/delete" method="POST">
                          <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i gi·∫£ng <strong>"{{title}}"</strong>?</p>
                            <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="submit" class="btn btn-danger">X√≥a</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                {{/each}}
              </tbody>
            </table>
          {{else}}
            <p class="text-muted">Ch∆∞a c√≥ b√†i gi·∫£ng n√†o.</p>
          {{/if}}

          {{!-- N√∫t th√™m Lecture --}}
          <div class="border-top pt-3 mt-3">
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addLectureModal{{id}}">
              <i class="bi bi-plus-circle"></i> Th√™m b√†i gi·∫£ng v√†o ch∆∞∆°ng n√†y
            </button>
          </div>

          {{!-- Modal Th√™m Lecture --}}
          <div class="modal fade" id="addLectureModal{{id}}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form action="/teacher/chapter/{{id}}/lecture/add" method="POST" enctype="multipart/form-data">
                  <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Th√™m b√†i gi·∫£ng v√†o Ch∆∞∆°ng {{chapter_order}}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="fw-semibold">T√™n b√†i gi·∫£ng <span class="text-danger">*</span></label>
                      <input type="text" name="title" class="form-control" placeholder="VD: Gi·ªõi thi·ªáu v·ªÅ React Hooks" required>
                    </div>
                    <div class="mb-3">
                      <label class="fw-semibold">Video <span class="text-danger">*</span></label>
                      <input type="file" name="video" class="form-control" accept="video/*" required>
                      <small class="text-muted">ƒê·ªãnh d·∫°ng: MP4, AVI, MOV, WebM</small>
                    </div>
                    <div class="mb-3">
                      <label class="fw-semibold">Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
                      <input type="number" name="duration_minutes" class="form-control" placeholder="VD: 15" min="0">
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="is_preview_allowed" id="previewNew{{id}}">
                      <label class="form-check-label" for="previewNew{{id}}">
                        Cho ph√©p xem tr∆∞·ªõc mi·ªÖn ph√≠
                      </label>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-success">Th√™m b√†i gi·∫£ng</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          {{!-- Modal S·ª≠a Chapter --}}
          <div class="modal fade" id="editChapterModal{{id}}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form action="/teacher/chapter/{{id}}/edit" method="POST">
                  <div class="modal-header">
                    <h5 class="modal-title">S·ª≠a Ch∆∞∆°ng {{chapter_order}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="fw-semibold">T√™n ch∆∞∆°ng</label>
                      <input type="text" name="title" class="form-control" value="{{title}}" required>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          {{!-- Modal X√≥a Chapter --}}
          <div class="modal fade" id="deleteChapterModal{{id}}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form action="/teacher/chapter/{{id}}/delete" method="POST">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">X√°c nh·∫≠n x√≥a ch∆∞∆°ng</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a <strong>Ch∆∞∆°ng {{chapter_order}}: {{title}}</strong>?</p>
                    <p class="text-danger">
                      <i class="bi bi-exclamation-triangle"></i> 
                      T·∫•t c·∫£ b√†i gi·∫£ng trong ch∆∞∆°ng n√†y c≈©ng s·∫Ω b·ªã x√≥a!
                    </p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-danger">X√≥a ch∆∞∆°ng</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

      </div>
    {{/each}}
  {{else}}
    <div class="alert alert-info text-center">
      <i class="bi bi-info-circle"></i> Ch∆∞a c√≥ ch∆∞∆°ng n√†o ƒë∆∞·ª£c t·∫°o. H√£y th√™m ch∆∞∆°ng ƒë·∫ßu ti√™n!
    </div>
  {{/if}}
</div>

{{!-- Modal Th√™m Chapter --}}
<div class="modal fade" id="addChapterModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/teacher/course/{{course.id}}/chapter/add" method="POST">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Th√™m ch∆∞∆°ng m·ªõi</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="fw-semibold">T√™n ch∆∞∆°ng <span class="text-danger">*</span></label>
            <input type="text" name="title" class="form-control" placeholder="VD: Gi·ªõi thi·ªáu v·ªÅ kh√≥a h·ªçc" required>
          </div>
          <small class="text-muted">
            <i class="bi bi-info-circle"></i> Ch∆∞∆°ng s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ƒë√°nh s·ªë th·ª© t·ª±
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="submit" class="btn btn-primary">Th√™m ch∆∞∆°ng</button>
        </div>
      </form>
    </div>
  </div>
</div>

{{!-- N√∫t quay l·∫°i Dashboard v√† Xem chi ti·∫øt (cu·ªëi c√πng) --}}
<div class="container my-4 d-flex gap-2">
  <a href="/teacher/dashboard" class="btn btn-secondary">
    <i class="bi bi-arrow-left"></i> Quay l·∫°i Dashboard
  </a>
  <a href="/teacher/course/{{course.id}}/detail" class="btn btn-info">
    <i class="bi bi-eye"></i> Xem chi ti·∫øt
  </a>
</div>
{{!-- TinyMCE Editor --}}
<script src="hw9pfh30njixlu4voz8ag8msnnnr4ofingpiklyaaie8hhdy" referrerpolicy="origin"></script>
<script>
  tinymce.init({
    selector: '#editor',
    height: 400,
    plugins: 'lists link image table code',
    toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image table | code',
    menubar: false
  });
</script>