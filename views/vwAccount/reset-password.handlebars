<link rel="stylesheet" href="/static/css/auth.css">

<div class="auth-wrapper">
    <div class="container">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="bi bi-shield-lock" style="font-size:3rem;color:#5624d0;"></i>
                <h2 class="mt-3">Reset your password</h2>
                <p>Enter the 6-digit code sent to</p>
                <p class="fw-bold text-primary">{{email}}</p>
            </div>

            {{#if error}}
            <div class="alert alert-danger alert-custom"><i class="bi bi-exclamation-circle"></i> {{error}}</div>
            {{/if}}

            {{#if resent}}
            <div class="alert alert-success alert-custom"><i class="bi bi-check-circle"></i> A new code has been sent.
            </div>
            {{/if}}

            <form method="post" action="/account/reset-password" id="resetForm" class="auth-form">
                <input type="hidden" name="email" value="{{email}}">

                <label class="form-label"><i class="bi bi-123"></i> OTP Code</label>
                <div class="otp-inputs mb-3">
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                </div>
                <input type="hidden" name="otp_code" id="otp_code">

                <div class="mb-3">
                    <label class="form-label" for="new_password"><i class="bi bi-lock"></i> New password</label>
                    <input class="form-control" id="new_password" name="new_password" type="password" minlength="6"
                        required>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="confirm_password"><i class="bi bi-lock-fill"></i> Confirm new
                        password</label>
                    <input class="form-control" id="confirm_password" name="confirm_password" type="password"
                        minlength="6" required>
                </div>

                <button class="btn btn-primary" type="submit" id="btnSubmit">
                    <i class="bi bi-check-circle"></i> Update password
                </button>
            </form>

            <div class="resend-otp">
                <p class="mb-2">Didnâ€™t get the code?</p>
                <form method="post" action="/account/resend-reset-otp" id="resendForm" class="d-inline">
                    <input type="hidden" name="email" value="{{email}}">
                    <button type="submit" id="btnResend" class="border-0 bg-transparent">
                        Resend code (<span id="countdown">60</span>s)
                    </button>
                </form>
            </div>

            <div class="auth-footer">
                <a href="/account/forgot-password"><i class="bi bi-arrow-left"></i> Back</a>
            </div>
        </div>
    </div>
</div>

<script>
    // OTP inputs
    const inputs = document.querySelectorAll('.otp-input');
    const otpHidden = document.getElementById('otp_code');
    inputs[0]?.focus();
    inputs.forEach((input, idx) => {
        input.addEventListener('input', function () {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value && idx < inputs.length - 1) inputs[idx + 1].focus();
        });
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Backspace' && !this.value && idx > 0) inputs[idx - 1].focus();
        });
        input.addEventListener('paste', function (e) {
            e.preventDefault();
            const s = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
            for (let i = 0; i < Math.min(s.length, 6); i++) inputs[i].value = s[i] || '';
            inputs[Math.min(s.length, 5)]?.focus();
        });
    });
    document.getElementById('resetForm')?.addEventListener('submit', function (e) {
        let code = '';
        inputs.forEach(i => code += i.value);
        if (code.length !== 6) {
            e.preventDefault();
            alert('Please enter the 6-digit code.');
            return;
        }
        otpHidden.value = code;
        const b = document.getElementById('btnSubmit');
        b.disabled = true;
        b.classList.add('btn-loading');
        b.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    });

    // resend countdown
    let countdown = 60;
    const btnResend = document.getElementById('btnResend');
    const countdownEl = document.getElementById('countdown');
    btnResend.disabled = true;
    const timer = setInterval(() => {
        countdown--; countdownEl.textContent = countdown;
        if (countdown <= 0) { clearInterval(timer); btnResend.disabled = false; btnResend.innerHTML = 'Resend code'; }
    }, 1000);
</script>