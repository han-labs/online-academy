<link rel="stylesheet" href="/static/css/auth.css">

<div class="auth-wrapper">
    <div class="container">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="bi bi-envelope-check" style="font-size: 3rem; color: #5624d0;"></i>
                <h2 class="mt-3">Email Verification</h2>
                <p>We have sent a verification code to</p>
                <p class="fw-bold text-primary">{{email}}</p>
            </div>

            {{#if error}}
            <div class="alert alert-danger alert-custom" role="alert">
                <i class="bi bi-exclamation-circle"></i> {{error}}
            </div>
            {{/if}}

            <form method="post" action="/account/verify-otp" id="otpForm">
                <input type="hidden" name="email" value="{{email}}">

                <div class="otp-inputs">
                    <input type="text" class="otp-input" maxlength="1" name="otp1" id="otp1" required>
                    <input type="text" class="otp-input" maxlength="1" name="otp2" id="otp2" required>
                    <input type="text" class="otp-input" maxlength="1" name="otp3" id="otp3" required>
                    <input type="text" class="otp-input" maxlength="1" name="otp4" id="otp4" required>
                    <input type="text" class="otp-input" maxlength="1" name="otp5" id="otp5" required>
                    <input type="text" class="otp-input" maxlength="1" name="otp6" id="otp6" required>
                </div>

                <input type="hidden" name="otp_code" id="otp_code">

                <button type="submit" class="btn btn-primary" id="btnVerify">
                    <i class="bi bi-check-circle"></i> Verify
                </button>
            </form>

            <div class="resend-otp">
                <p class="mb-2">Didn't receive the code?</p>
                <form method="post" action="/account/resend-otp" id="resendForm" class="d-inline">
                    <input type="hidden" name="email" value="{{email}}">
                    <button type="submit" id="btnResend" class="border-0 bg-transparent">
                        Resend code (<span id="countdown">60</span>s)
                    </button>
                </form>
            </div>

            <div class="auth-footer">
                <a href="/account/register">
                    <i class="bi bi-arrow-left"></i> Back to Register
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Auto focus first input
    document.getElementById('otp1')?.focus();

    // Handle OTP input
    const inputs = document.querySelectorAll('.otp-input');

    inputs.forEach((input, index) => {
        // Only allow numbers
        input.addEventListener('input', function (e) {
            this.value = this.value.replace(/[^0-9]/g, '');

            // Auto move to next input
            if (this.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });

        // Handle backspace
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                inputs[index - 1].focus();
            }
        });

        // Handle paste
        input.addEventListener('paste', function (e) {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');

            for (let i = 0; i < Math.min(pasteData.length, 6); i++) {
                if (inputs[i]) {
                    inputs[i].value = pasteData[i];
                }
            }

            // Focus last filled input
            const lastIndex = Math.min(pasteData.length, 5);
            inputs[lastIndex]?.focus();
        });
    });

    // Form submit
    document.getElementById('otpForm')?.addEventListener('submit', function (e) {
        const btn = document.getElementById('btnVerify');

        // Combine OTP digits
        let otpCode = '';
        inputs.forEach(input => otpCode += input.value);

        if (otpCode.length !== 6) {
            e.preventDefault();
            alert('Please enter all 6 digits.');
            return false;
        }

        document.getElementById('otp_code').value = otpCode;

        // Loading state
        btn.disabled = true;
        btn.classList.add('btn-loading');
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Verifying...';
    });

    // Countdown for resend
    let countdown = 60;
    const btnResend = document.getElementById('btnResend');
    const countdownEl = document.getElementById('countdown');

    btnResend.disabled = true;

    const timer = setInterval(() => {
        countdown--;
        countdownEl.textContent = countdown;

        if (countdown <= 0) {
            clearInterval(timer);
            btnResend.disabled = false;
            btnResend.innerHTML = 'Resend code';
        }
    }, 1000);

    // Resend OTP
    document.getElementById('resendForm')?.addEventListener('submit', function (e) {
        btnResend.disabled = true;
        btnResend.innerHTML = 'Sending...';

        // Reset countdown after form submits
        setTimeout(() => {
            countdown = 60;
            const newTimer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(newTimer);
                    btnResend.disabled = false;
                    btnResend.innerHTML = 'Resend code';
                }
            }, 1000);
        }, 1000);
    });
</script>
